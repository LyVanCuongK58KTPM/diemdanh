<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GV - H·ªá Th·ªëng ƒêi·ªÉm Danh</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
    .navbar-brand i { margin-right: 8px; }
    .nav-pills .nav-link.active { background-color: #0d6efd; color: #fff; font-weight: 600; }
    .nav-pills .nav-link { border-radius: 50px; margin-right: 8px; transition: 0.3s; }
    .nav-pills .nav-link:hover { background-color: #0b5ed7; color: #fff; }
    .video-container { position: relative; overflow: hidden; border-radius: 15px; background: #000; }
    video { width: 100%; height: auto; display: block; border-radius: 15px; }
    #scanLine { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, transparent, #0f0, transparent); animation: scan 2s infinite linear; display: none; z-index: 10; }
    @keyframes scan { 0% {top:0%} 100% {top:100%} }
    .scan-status { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); color: #fff; background: rgba(0,0,0,0.6); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; }
    .card { border-radius: 15px; }
    .table thead { background-color: #0d6efd; color: #fff; }
    .btn-round { border-radius: 50px; }
    .form-select, .form-control { border-radius: 10px; }
    .modal-content { border-radius: 15px; }
    .badge-success { background-color: #198754; }
    .badge-warning { background-color: #ffc107; color: #000; }
    .tab-pane { padding-top: 15px; }
</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#"><i class="fas fa-user-tie"></i> GV: {{ gv.ho_ten }}</a>
        <div>
            <a href="/logout" class="btn btn-light text-danger fw-bold btn-sm"><i class="fas fa-power-off"></i> Tho√°t</a>
        </div>
    </div>
</nav>

<div class="container pb-5">

    <!-- MENU TAB -->
    <ul class="nav nav-pills nav-fill mb-4 shadow-sm p-2 bg-white rounded-4" id="pills-tab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-cam">üì∑ ƒêi·ªÉm Danh</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-schedule">üìÖ L·ªãch D·∫°y</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-history">üìä B√°o C√°o</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-profile">üë§ C√° Nh√¢n</button></li>
    </ul>

    <div class="tab-content" id="pills-tabContent">

        <!-- TAB 1: CAMERA -->
        <div class="tab-pane fade show active" id="pills-cam">
            <div class="row g-4">
                <div class="col-md-7">
                    <div class="card shadow h-100 p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="text-primary fw-bold"><i class="fas fa-video"></i> Camera AI</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoScanToggle" onchange="toggleAutoScan()">
                                <label class="form-check-label fw-bold text-success" for="autoScanToggle">Auto Scan</label>
                            </div>
                        </div>
                        <select id="lichSelect" class="form-select mb-2">
                            <option value="" disabled selected>-- Ch·ªçn l·ªõp --</option>
                            {% for lich in schedule %}
                                <option value="{{ lich.lich_id }}">{{ lich.ten_mon }} - {{ lich.ten_lop }} ({{ lich.gio_bat_dau }})</option>
                            {% endfor %}
                        </select>
                        <select id="cameraSelect" class="form-select mb-3"></select>
                        <div class="video-container mb-3">
                            <video id="video" autoplay playsinline></video>
                            <canvas id="canvas" style="display:none;"></canvas>
                            <div id="scanLine"></div>
                            <div id="scanStatus" class="scan-status">S·∫µn s√†ng</div>
                        </div>
                        <button id="btnSnap" class="btn btn-primary w-100 fw-bold btn-round" onclick="manualScan()"><i class="fas fa-hand-paper"></i> Ch·ª•p Th·ªß C√¥ng</button>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="card shadow h-100 p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="text-success fw-bold mb-0"><i class="fas fa-users"></i> ƒê√£ C√≥ M·∫∑t</h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="loadList()"><i class="fas fa-sync"></i></button>
                        </div>
                        <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                            <table class="table table-hover mb-0">
                                <thead class="table-light sticky-top">
                                    <tr><th>M√£ SV</th><th>H·ªç T√™n</th><th>Gi·ªù v√†o</th></tr>
                                </thead>
                                <tbody id="liveTableBody">
                                    <tr><td colspan="3" class="text-center py-4 text-muted">Ch∆∞a ch·ªçn l·ªõp</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: L·ªäCH D·∫†Y -->
        <div class="tab-pane fade" id="pills-schedule">
            <div class="card shadow p-3">
                <h4 class="text-primary mb-3"><i class="fas fa-calendar-alt"></i> Qu·∫£n L√Ω L·ªãch D·∫°y</h4>
                <div class="table-responsive">
                    <table class="table table-hover table-striped align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Th·ª©</th><th>M√¥n H·ªçc</th><th>L·ªõp</th><th>Th·ªùi Gian</th><th>Ph√≤ng</th><th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lich in schedule %}
                            <tr>
                                <td class="fw-bold text-center">Th·ª© {{ lich.thu_trong_tuan }}</td>
                                <td>{{ lich.ten_mon }}</td>
                                <td>{{ lich.ten_lop }}</td>
                                <td>{{ lich.gio_bat_dau }} - {{ lich.gio_ket_thuc }}</td>
                                <td class="text-center fw-bold text-danger">{{ lich.phong_hoc }}</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-warning btn-round text-white" 
                                            onclick="openEditModal('{{ lich.lich_id }}','{{ lich.thu_trong_tuan }}','{{ lich.ten_mon }}','{{ lich.ten_lop }}','{{ lich.gio_bat_dau }}','{{ lich.gio_ket_thuc }}','{{ lich.phong_hoc }}')">
                                        <i class="fas fa-pen"></i> S·ª≠a
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" class="text-center py-3">Kh√¥ng c√≥ l·ªãch d·∫°y.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 3: B√ÅO C√ÅO & EXCEL -->
        <div class="tab-pane fade" id="pills-history">
            <div class="card shadow p-3">
                <h4 class="text-success mb-3"><i class="fas fa-file-export"></i> B√°o C√°o & Excel</h4>
                <div class="row g-3 mb-3 bg-light p-3 rounded-3">
                    <div class="col-md-4">
                        <label class="fw-bold">M√¥n H·ªçc:</label>
                        <select id="filterMon" class="form-select">
                            <option value="">-- T·∫•t c·∫£ --</option>
                            {% for m in ds_mon %}<option value="{{ m.mon_id }}">{{ m.ten_mon }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="fw-bold">Ng√†y H·ªçc:</label>
                        <input type="date" id="filterDate" class="form-control">
                    </div>
                    <div class="col-md-4 d-flex align-items-end gap-2">
                        <button class="btn btn-primary flex-grow-1 btn-round" onclick="filterHistory()"><i class="fas fa-search"></i> Xem</button>
                        <button class="btn btn-success flex-grow-1 btn-round" onclick="exportExcel()"><i class="fas fa-download"></i> Excel</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-secondary">
                            <tr><th>Ng√†y</th><th>M√£ SV</th><th>H·ªç T√™n</th><th>L·ªõp</th><th>M√¥n</th><th>Gi·ªù V√†o</th><th>TT</th></tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr><td colspan="7" class="text-center py-3 text-muted">Ch·ªçn ƒëi·ªÅu ki·ªán l·ªçc...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 4: TH√îNG TIN C√Å NH√ÇN -->
        <div class="tab-pane fade" id="pills-profile">
            <div class="row justify-content-center g-4">
                <div class="col-md-8">

                    <!-- C·∫¨P NH·∫¨T TH√îNG TIN -->
                    <div class="card shadow p-3">
                        <div class="card-header bg-info text-white fw-bold"><i class="fas fa-user-edit"></i> C·∫≠p Nh·∫≠t Th√¥ng Tin</div>
                        <div class="card-body">
                            <form action="/update_profile" method="POST">
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label fw-bold">H·ªç T√™n:</label>
                                    <div class="col-sm-9"><input type="text" class="form-control-plaintext" value="{{ gv.ho_ten }}" readonly></div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label fw-bold">M√£ GV:</label>
                                    <div class="col-sm-9"><input type="text" class="form-control-plaintext" value="{{ gv.ma_gv }}" readonly></div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label fw-bold">Email:</label>
                                    <div class="col-sm-9"><input type="email" name="email" class="form-control" value="{{ gv.email or '' }}" placeholder="Nh·∫≠p email"></div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label fw-bold">S·ªë ƒêT:</label>
                                    <div class="col-sm-9"><input type="text" name="sdt" class="form-control" value="{{ gv.sdt or '' }}" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"></div>
                                </div>
                                <div class="text-end">
                                    <button type="submit" class="btn btn-info text-white fw-bold btn-round">L∆∞u Thay ƒê·ªïi</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- ƒê·ªîI M·∫¨T KH·∫®U -->
                    <div class="card shadow p-3 mt-3 border-top border-warning border-3">
                        <div class="card-body">
                            <h5 class="text-warning fw-bold mb-3"><i class="fas fa-key"></i> ƒê·ªïi M·∫≠t Kh·∫©u</h5>
                            <form action="/change_password" method="POST">
                                <div class="input-group mb-2">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" name="old_pass" class="form-control" placeholder="M·∫≠t kh·∫©u c≈©" required>
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text"><i class="fas fa-key"></i></span>
                                    <input type="password" name="new_pass" class="form-control" placeholder="M·∫≠t kh·∫©u m·ªõi" required>
                                </div>
                                <div class="input-group mb-3">
                                    <span class="input-group-text"><i class="fas fa-check-circle"></i></span>
                                    <input type="password" name="confirm_pass" class="form-control" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" required>
                                </div>
                                <button type="submit" class="btn btn-warning w-100 fw-bold btn-round">ƒê·ªïi M·∫≠t Kh·∫©u</button>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<!-- MODAL S·ª¨A L·ªäCH -->
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold"><i class="fas fa-pen"></i> Ch·ªânh S·ª≠a L·ªãch D·∫°y</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/update_schedule" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="lich_id" id="modalLichId">
                    <div class="mb-2">
                        <label class="fw-bold">M√¥n H·ªçc - L·ªõp:</label>
                        <input type="text" class="form-control" id="modalMonLop" readonly style="background-color:#e9ecef;">
                    </div>
                    <div class="row mb-2">
                        <div class="col">
                            <label class="fw-bold">Th·ª©:</label>
                            <select name="thu" id="modalThu" class="form-select">
                                <option value="2">Th·ª© 2</option><option value="3">Th·ª© 3</option>
                                <option value="4">Th·ª© 4</option><option value="5">Th·ª© 5</option>
                                <option value="6">Th·ª© 6</option><option value="7">Th·ª© 7</option>
                                <option value="8">Ch·ªß Nh·∫≠t</option>
                            </select>
                        </div>
                        <div class="col">
                            <label class="fw-bold">Ph√≤ng H·ªçc:</label>
                            <input type="text" name="phong_hoc" id="modalPhong" class="form-control" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label class="fw-bold">Gi·ªù B·∫Øt ƒê·∫ßu:</label>
                            <input type="time" name="gio_bat_dau" id="modalGioBd" class="form-control" step="1" required>
                        </div>
                        <div class="col">
                            <label class="fw-bold">Gi·ªù K·∫øt Th√∫c:</label>
                            <input type="time" name="gio_ket_thuc" id="modalGioKt" class="form-control" step="1" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-round" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary btn-round">L∆∞u L·∫°i</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- AUDIO & SCRIPT -->
<audio id="beepAudio" src="https://actions.google.com/sounds/v1/science_fiction/beep_short.ogg"></audio>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- MODAL S·ª¨A L·ªäCH ---
    function openEditModal(id, thu, mon, lop, gioBd, gioKt, phong) {
        document.getElementById('modalLichId').value = id;
        document.getElementById('modalThu').value = thu;
        document.getElementById('modalMonLop').value = `${mon} - ${lop}`;
        document.getElementById('modalPhong').value = phong;
        document.getElementById('modalGioBd').value = formatTime(gioBd);
        document.getElementById('modalGioKt').value = formatTime(gioKt);
        new bootstrap.Modal(document.getElementById('editScheduleModal')).show();
    }

    function formatTime(timeStr) {
        if (!timeStr) return "";
        return timeStr.length === 7 ? "0"+timeStr : timeStr; 
    }

    // --- CAMERA & QU√âT ---
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const cameraSelect = document.getElementById('cameraSelect');
    const scanStatus = document.getElementById('scanStatus');
    const scanLine = document.getElementById('scanLine');
    const beepAudio = document.getElementById('beepAudio');
    let scanInterval = null;
    let isProcessing = false;

    async function initCamera() {
        try {
            await navigator.mediaDevices.getUserMedia({ video: true });
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoInputs = devices.filter(d => d.kind === 'videoinput');
            cameraSelect.innerHTML = "";
            videoInputs.forEach((d,i) => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                opt.text = d.label || `Cam ${i+1}`;
                cameraSelect.appendChild(opt);
            });
            if(videoInputs.length > 0) startStream(videoInputs[0].deviceId);
        } catch(e) {
            console.error(e);
            Swal.fire("L·ªói", "Kh√¥ng th·ªÉ m·ªü camera.", "error");
        }
    }

    async function startStream(deviceId) {
        if (!deviceId) return;
        const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } });
        video.srcObject = stream;
    }
    cameraSelect.onchange = () => startStream(cameraSelect.value);
    initCamera();

    function toggleAutoScan() {
        if(document.getElementById('autoScanToggle').checked) {
            const lichId = document.getElementById('lichSelect').value;
            if(!lichId) {
                document.getElementById('autoScanToggle').checked = false;
                return Swal.fire("L·ªói", "Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc!", "warning");
            }
            scanInterval = setInterval(() => captureAndSend(false), 2500);
            scanLine.style.display = 'block';
            scanStatus.innerText = "üü¢ ƒêang qu√©t t·ª± ƒë·ªông...";
        } else {
            clearInterval(scanInterval);
            scanLine.style.display = 'none';
            scanStatus.innerText = "‚ö™ ƒê√£ d·ª´ng qu√©t";
        }
    }

    function manualScan() { captureAndSend(true); }

    function captureAndSend(isManual) {
        const lichId = document.getElementById('lichSelect').value;
        if(!lichId) { if(isManual) Swal.fire("Ch√∫ √Ω", "Ch∆∞a ch·ªçn l·ªõp!", "warning"); return; }
        if(isProcessing) return;
        isProcessing = true;
        if(isManual) scanStatus.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const dataURL = canvas.toDataURL('image/jpeg', 0.7);

        fetch('/process_attendance', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ image: dataURL, lich_id: lichId })
        }).then(r => r.json()).then(data => {
            if(data.status === 'success') {
                beepAudio.play().catch(()=>{});
                scanStatus.innerText = `‚úÖ ${data.message}`;
                scanStatus.style.color = "#0f0";
                if(isManual) Swal.fire({icon:'success', title:data.message, timer:1000, showConfirmButton:false});
                loadList();
            } else {
                scanStatus.innerText = "‚ö†Ô∏è Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c";
                scanStatus.style.color = "yellow";
                if(isManual && data.status==='error') Swal.fire("L·ªói", data.message, "error");
            }
        }).finally(() => {
            isProcessing = false;
            if(document.getElementById('autoScanToggle').checked) {
                setTimeout(() => { scanStatus.innerText = "üü¢ ƒêang qu√©t..."; scanStatus.style.color = "#fff"; }, 1500);
            }
        });
    }

    function loadList() {
        const lichId = document.getElementById('lichSelect').value;
        if(!lichId) return;
        fetch('/get_attendance_list', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({lich_id: lichId})
        }).then(r=>r.json()).then(res=>{
            const tbody = document.getElementById('liveTableBody');
            tbody.innerHTML = "";
            if(res.data.length===0){
                tbody.innerHTML = `<tr><td colspan="3" class="text-center py-3 text-muted">Ch∆∞a c√≥ sinh vi√™n</td></tr>`;
                return;
            }
            let html = "";
            res.data.forEach(sv=>{
                html += `<tr><td class="fw-bold">${sv.ma_sv}</td><td>${sv.ho_ten}</td><td><span class="badge bg-success">${sv.thoi_gian_vao}</span></td></tr>`;
            });
            tbody.innerHTML = html;
        });
    }

    function filterHistory() {
        const monId = document.getElementById('filterMon').value;
        const dateVal = document.getElementById('filterDate').value;
        fetch('/filter_attendance',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({mon_id:monId, ngay_hoc:dateVal})
        }).then(r=>r.json()).then(res=>{
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = "";
            if(res.data.length===0){ 
                tbody.innerHTML=`<tr><td colspan="7" class="text-center py-3">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
                return;
            }
            let html = "";
            res.data.forEach(r=>{
                html += `<tr>
                    <td>${r.ngay_diem_danh}</td>
                    <td class="fw-bold">${r.ma_sv}</td>
                    <td>${r.ho_ten}</td>
                    <td>${r.ten_lop}</td>
                    <td>${r.ten_mon}</td>
                    <td>${r.thoi_gian_vao}</td>
                    <td><span class="badge bg-success">${r.trang_thai}</span></td>
                </tr>`;
            });
            tbody.innerHTML = html;
        });
    }

    function exportExcel() {
        const monId = document.getElementById('filterMon').value;
        const dateVal = document.getElementById('filterDate').value;
        window.location.href = `/export_excel?mon_id=${monId}&ngay_hoc=${dateVal}`;
    }
</script>
{% include 'alerts.html' %}
</body>
</html>
